<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Password Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            max-width: 420px;
            width: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .icon-bubble {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .icon-bubble svg {
            width: 32px;
            height: 32px;
            stroke: white;
            stroke-width: 2;
        }

        h1 {
            font-size: 28px;
            color: #111827;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .subtitle {
            color: #6b7280;
            font-size: 15px;
            line-height: 1.5;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: flex-start;
            gap: 12px;
        }

        .alert svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .alert-error {
            background: #fee;
            color: #c00;
        }

        .alert-success {
            background: #efe;
            color: #0a0;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn svg {
            width: 20px;
            height: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 24px;
            color: #6b7280;
            font-size: 14px;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none !important;
        }

        .step {
            animation: fadeIn 0.3s ease-out;
        }

        .info-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        .success-icon {
            width: 64px;
            height: 64px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .success-icon svg {
            width: 32px;
            height: 32px;
            stroke: white;
            stroke-width: 3;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Step 1: Email Entry -->
        <div id="emailStep" class="step">
            <div class="header">
                <div class="icon-bubble">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                </div>
                <h1>Forgot Password?</h1>
                <p class="subtitle">Enter your email and we'll send you a verification code</p>
            </div>

            <div id="emailErrorAlert" class="alert alert-error">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span id="emailErrorText"></span>
            </div>

            <form id="emailForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" placeholder="you@example.com" required autocomplete="email">
                </div>

                <button type="submit" id="emailBtn" class="btn btn-primary">
                    <span>Send Verification Code</span>
                </button>

                <button type="button" class="btn btn-secondary" onclick="window.location.href='login-standalone-with-otp.html'" style="margin-top: 12px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span>Back to Login</span>
                </button>
            </form>
        </div>

        <!-- Step 2: OTP Verification -->
        <div id="otpStep" class="step hidden">
            <div class="header">
                <div class="icon-bubble">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <h1>Verify Your Email</h1>
                <p class="subtitle">Enter the 6-digit code sent to <strong id="sentEmail"></strong></p>
            </div>

            <div id="otpErrorAlert" class="alert alert-error">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span id="otpErrorText"></span>
            </div>

            <form id="otpForm">
                <div class="form-group">
                    <label for="otp">Verification Code</label>
                    <input type="text" id="otp" placeholder="000000" required pattern="[0-9]{6}" maxlength="6" autocomplete="one-time-code">
                </div>

                <button type="submit" id="otpBtn" class="btn btn-primary">
                    <span>Verify Code</span>
                </button>

                <button type="button" class="btn btn-secondary" onclick="location.reload()" style="margin-top: 12px;">
                    <span>Use Different Email</span>
                </button>
            </form>
        </div>

        <!-- Step 3: Reset Password -->
        <div id="resetStep" class="step hidden">
            <div class="header">
                <div class="icon-bubble">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h1>Reset Password</h1>
                <p class="subtitle">Enter your new master password</p>
            </div>

            <div id="resetErrorAlert" class="alert alert-error">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span id="resetErrorText"></span>
            </div>

            <div class="info-box">
                <p><strong>Password Requirements:</strong><br>
                • At least 8 characters long<br>
                • Contains uppercase and lowercase letters<br>
                • Contains at least one number<br>
                • Contains at least one special character</p>
            </div>

            <form id="resetForm">
                <div class="form-group">
                    <label for="newPassword">New Master Password</label>
                    <input type="password" id="newPassword" placeholder="••••••••" required minlength="8">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="••••••••" required minlength="8">
                </div>

                <button type="submit" id="resetBtn" class="btn btn-primary">
                    <span>Reset Password</span>
                </button>
            </form>
        </div>

        <!-- Step 4: Success -->
        <div id="successStep" class="step hidden">
            <div class="header">
                <div class="success-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h1>Password Reset Successful!</h1>
                <p class="subtitle">Your password has been successfully reset. You can now login with your new password.</p>
            </div>

            <button class="btn btn-primary" onclick="window.location.href='login-standalone-with-otp.html'">
                <span>Go to Login</span>
            </button>
        </div>
    </div>

<script>
    const BACKEND_URL = "https://epscord-password-manager-api.hf.space"; 
    const BASE_URL = "https://epscord-password-manager-api.hf.space"; 
    
    console.log("Backend targeted at:", BACKEND_URL);

    let userEmail = '';
    let resetToken = '';

    document.getElementById('emailForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const btn = document.getElementById('emailBtn');
        const errorAlert = document.getElementById('emailErrorAlert');
        
        btn.disabled = true;
        btn.innerHTML = '<span>Sending...</span>';
        errorAlert.style.display = 'none';

        try {
            // ✅ This must point to the HF Space, not github.io
            const response = await fetch(`${BACKEND_URL}/api/auth/forgot-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await response.json();

            if (response.ok) {
                userEmail = email;
                document.getElementById('sentEmail').textContent = email;
                document.getElementById('emailStep').classList.add('hidden');
                document.getElementById('otpStep').classList.remove('hidden');
            } else {
                throw new Error(data.message || 'Failed to send verification code');
            }
        } catch (error) {
            console.error("Connection Error:", error);
            document.getElementById('emailErrorText').textContent = "Server Connection Failed. Check Backend URL.";
            errorAlert.style.display = 'flex';
            btn.disabled = false;
            btn.innerHTML = '<span>Send Verification Code</span>';
        }
    });

    // OTP verification (Step 2)
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const otp = document.getElementById('otp').value;
        const btn = document.getElementById('otpBtn');
        const errorAlert = document.getElementById('otpErrorAlert');
        
        btn.disabled = true;
        btn.innerHTML = '<span>Verifying...</span>';
        errorAlert.style.display = 'none';

        try {
            // 3. Fix: Corrected endpoint path
            const response = await fetch(`${BASE_URL}/api/auth/verify-reset-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail, otp })
            });

            const data = await response.json();

            if (response.ok) {
                resetToken = data.resetToken;
                document.getElementById('otpStep').classList.add('hidden');
                document.getElementById('resetStep').classList.remove('hidden');
            } else {
                throw new Error(data.message || 'Invalid verification code');
            }
        } catch (error) {
            document.getElementById('otpErrorText').textContent = error.message;
            errorAlert.style.display = 'flex';
            btn.disabled = false;
            btn.innerHTML = '<span>Verify Code</span>';
        }
    });

    // Password reset (Step 3)
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const btn = document.getElementById('resetBtn');
        const errorAlert = document.getElementById('resetErrorAlert');
        
        errorAlert.style.display = 'none';

        if (newPassword !== confirmPassword) {
            document.getElementById('resetErrorText').textContent = 'Passwords do not match';
            errorAlert.style.display = 'flex';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span>Resetting...</span>';

        try {
            // Hash the password to match your registration/login logic
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(newPassword);
            const hashBuffer = await crypto.subtle.digest('SHA-256', passwordData);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const masterPasswordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            const response = await fetch(`${BASE_URL}/api/auth/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: userEmail,
                    resetToken,
                    newPassword: masterPasswordHash
                })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('resetStep').classList.add('hidden');
                document.getElementById('successStep').classList.remove('hidden');
            } else {
                throw new Error(data.message || 'Failed to reset password');
            }
        } catch (error) {
            document.getElementById('resetErrorText').textContent = error.message;
            errorAlert.style.display = 'flex';
            btn.disabled = false;
            btn.innerHTML = '<span>Reset Password</span>';
        }
    });

    // Clean input for OTP
    document.getElementById('otp').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '');
    });
</script>
</body>
</html>
